# gw 仕様書

`gw` は git worktree の薄いラッパー CLI ツールである。パス自動計算とフック実行を核とする。

**設計方針:** フックで実現可能な機能は基本的に本体に組み込まない。

**出力規約:** stdout にはデータ（パス等）のみを出力し、stderr にログ・フック出力・エラーを出力する。

**リポジトリ検出:** worktree 内から実行された場合でも、メインリポジトリを正しく検出して動作する。

---

## 1. コマンド

**共通ルール:** 各コマンドは定義されていない引数・オプションが渡された場合はエラーとする。

- `gw init` — `.gw/` ディレクトリと初期ファイルを作成する。
- `gw add <branch>` — worktree を作成し、作成先パスを stdout に出力する。
- `gw rm <path>` — worktree をパス指定で削除する。ブランチは削除しない（`git worktree remove` 準拠）。
- `gw list` — worktree の一覧を出力する。
- `gw completion bash|zsh|fish` — シェル補完スクリプトを生成する。

引数なしまたは不正なコマンドの場合、usage を stderr に出力し終了コード 1 で終了する（git 準拠）。

---

## 2. パス計算

### 2.1 ベースディレクトリ

worktree を格納する親ディレクトリ。

| 優先順位 | ソース | 値 |
|---|---|---|
| 1 | `.gw/config` の `worktrees_dir` | 指定されたパス（リポジトリルートからの相対パスまたは絶対パス） |
| 2 | デフォルト | リポジトリの隣のディレクトリ |

ベースディレクトリが存在しない場合は自動的に作成する。

### 2.2 ブランチ名サニタイズ

ブランチ名をファイルシステム上で安全なフォルダ名に変換する。

サニタイズ結果が無効な場合（空文字列、`.`、`..`）はエラーとする。サニタイズ後のディレクトリが既に存在する場合もエラーとする（異なるブランチ名が同じサニタイズ結果になるケースを含む）。

### 2.3 最終パス

```
<base_dir>/<sanitized-branch>
```

---

## 3. フックシステム

メインリポジトリルートの `.gw/hooks/` ディレクトリに実行可能ファイルを配置する（git hooks パターン）。

### 3.1 フックフェーズ

| フック名 | トリガー | 実行場所 |
|---|---|---|
| `pre-add` | worktree 作成前 | リポジトリルート |
| `post-add` | worktree 作成後 | worktree ディレクトリ |
| `pre-remove` | worktree 削除前 | worktree ディレクトリ |
| `post-remove` | worktree 削除後 | リポジトリルート |

### 3.2 フック環境変数

フック実行時に以下の環境変数がエクスポートされる:

| 変数 | 説明 |
|---|---|
| `GW_REPO_ROOT` | メインリポジトリルートの絶対パス |
| `GW_WORKTREE_PATH` | worktree の絶対パス（`pre-add` フックでは作成予定のパス。ディレクトリはまだ存在しない） |
| `GW_BRANCH` | ブランチ名 |

### 3.3 フック実行ルール

- フックファイルが存在しない場合: 何もせず成功扱い
- フックファイルが存在するが実行権限がない場合: エラー
- フックの stdout/stderr は親プロセスの stderr に流す
- 各フックは独立したサブプロセスで実行する

### 3.4 フック失敗時の動作

| フック | 失敗時の動作 | `--force` 時 |
|---|---|---|
| `pre-add` | **作成を中止**（終了コード 1） | - |
| `post-add` | 警告のみ（worktree は作成済み、終了コード 0） | - |
| `pre-remove` | **削除を中止**（終了コード 1） | 警告して削除を続行（終了コード 0） |
| `post-remove` | 警告のみ（worktree は削除済み、終了コード 0） | - |

### 3.5 フック実行タイミング

`pre-*` フックは、gw 内部の全ての前提条件チェック（引数検証、パス計算、起点 ref の解決等）が成功した後、対応する git コマンドの実行直前に呼び出される。前提条件チェックの失敗時にはフックは実行されない。

---

## 4. 設定ファイル

メインリポジトリルートの `.gw/config` に設定を記述する。ファイルが存在しない場合はすべてデフォルト値を使用する。

**ファイルフォーマット:** TOML

**未知のキー:** 前方互換性のため、未知のキーは無視する。

| キー | 説明 | デフォルト |
|---|---|---|
| `worktrees_dir` | worktree を格納するベースディレクトリ（絶対パスまたはリポジトリルートからの相対パス） | リポジトリの隣のディレクトリ |

---

## 5. エラー処理

エラー処理や usage 表示は urfave/cli に委譲し、gw コマンド自体の責務を最小化する。

---

## 6. 将来の拡張

- git worktree サブコマンドのパススルー
